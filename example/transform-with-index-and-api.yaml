---
# Enhanced pipeline configuration for both HTML transformation and API use
# This pipeline:
# 1. Sets fetch options including max-depth for following references
# 2. Loads TSL files from URLs including referenced TSLs
# 3. Transforms them to HTML using the embedded stylesheet
# 4. Generates an index.html file for the TSLs
# 5. Makes the TSLs available via the API

- set-fetch-options:
   - max-depth:2
   - user-agent:EU-TSL-Browser/1.0
   - timeout:60s
   - accept:application/xml,text/xml,application/xhtml+xml

- load:
   - https://ec.europa.eu/tools/lotl/eu-lotl.xml

- log:
   - "Loaded TSL from https://ec.europa.eu/tools/lotl/eu-lotl.xml"

# Select all certificates for API use (important step for API functionality)
- select:
   - include-referenced
   # Uncomment the following lines to filter by service type and/or status
   # - "service-type:http://uri.etsi.org/TrstSvc/Svctype/CA/QC"
   # - "status:http://uri.etsi.org/TrstSvc/TrustedList/Svcstatus/granted/"

# For logging/debugging
- log:
   - "TSLs loaded and cert pool selected for API use"

# Transform and generate HTML files (doesn't affect API)
- transform:
   - embedded:tsl-to-html.xslt
   - ./output
   - html

- generate_index:
   - ./output
   - "EU Trust Service Lists - Index"

- log:
   - "Transformation and index generation complete. Files saved to ./output directory"